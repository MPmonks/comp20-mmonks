<!-- Mary-Paule Monks
     Assignment #2
     Landmarks -->

<!DOCTYPE html>
<html>
    <head>
        <title>mpmap</title>
        <meta name="viewport" content="initial-scale=1.0">
        <meta charset="utf-8">
        <link rel="stylesheet" href="main.css">
    </head>
    <body>
        <div id="map"></div>
        <script>
            var map;
            function initMap() {
                //getting the user's current location
                navigator.geolocation.getCurrentPosition(setMap);
                
                function setMap(position) {
                    mylat = position.coords.latitude;
                    mylng = position.coords.longitude;
                    map = new google.maps.Map(document.getElementById('map', ), {
                    center: {lat: mylat, lng: mylng},
                    zoom: 14
                    });

                    makePostRequest(position, map);
                }

                
            }
            function makePostRequest(position, map){
                var request = new XMLHttpRequest();
                var url = "https://defense-in-derpth.herokuapp.com/sendLocation";
                var lat = position.coords.latitude;
                var lng = position.coords.longitude;
                var parameters =  "login=DeXTiZLm&lat=" +lat + "&lng=" + lng;
                var mySpot = new google.maps.LatLng(lat, lng);
                console.log(parameters);
                console.log(typeof parameters);
                
                //opening the request
                request.open("POST", url, true);

                //setting the request header
                request.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');

                //waiting for the readystate to become 4 and 
                //the request status to be 200
                //aka waiting for a good connection and all the data to come back
                request.onreadystatechange = function() {

                    if(request.readyState == 4 && request.status == 200) {
                        rawJSON = request.responseText;
                        
                        var info = JSON.parse(rawJSON);
                        console.log(info);
                        var me = {
                            url: 'mouse.jpg',
                            scaledSize: new google.maps.Size(80, 60)
                        };
                        var marker = new google.maps.Marker({
                            position: mySpot,
                            icon: me,
                            map: map
                        });
                        


                        info.landmarks.forEach(function(landmark) {
                            var lat = landmark.geometry.coordinates[0];
                            var lng = landmark.geometry.coordinates[1];
                            console.log(lat + " " + lng);
                            var image = {
                                url: 'peanut.jpg',
                                scaledSize: new google.maps.Size(90, 60)
                            }
                            var marker = new google.maps.Marker({
                                
                                position: new google.maps.LatLng(lng, lat),
                                icon: image,
                                map: map
                            })
                            var name = landmark.properties.Location_Name;
                            var details = landmark.properties.Details;
                            var contentString = "<h1>" + name + "</h1>" + details;
                            var infoWindow = new google.maps.InfoWindow({
                                content: contentString
                            });
                            marker.addListener('click', function() {
                                infoWindow.open(map, marker);
                            });
                        });


                        info.people.forEach(function(person) {
                            var lat = person.lat;
                            var lng = person.lng;
                            var landmarkSpot = new google.maps.LatLng(lat, lng);
                            var login = person.login;
                            var image = {
                                url: 'jumbo.png',
                                scaledSize: new google.maps.Size(75, 75),
                                origin: new google.maps.Point(0,0),
                                anchor: new google.maps.Point(0, 10)
                            };
                            var marker = new google.maps.Marker({
                                position: landmarkSpot,
                                icon: image,
                                map: map
                            })
                            console.log("landmark");
                            console.log(landmarkSpot.toString());
                            console.log("myspot");
                            console.log(mySpot.toString());
                            //var distance = google.maps.geometry.spherical.computeDistanceBetween(mySpot, landmarkSpot);
                            var contentString = "<h1>Login: " + login + "</h1><br>";
                            var infoWindow = new google.maps.InfoWindow({
                                content: contentString
                            });
                            marker.addListener('click', function() {
                                infoWindow.open(map, marker);
                            });
                        });

                       
                    }
                }

                //sending the request
                request.send(parameters);
            }
        </script>
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCqnXl7cHrvRs1z0OCxa-fhpOe9MEhE16c&callback=initMap"
                async defer></script>
  </body>
</html>