<!-- Mary-Paule Monks
     Assignment #2
     Landmarks -->

<!DOCTYPE html>
<html>
    <head>
        <title>mpmap</title>
        <meta name="viewport" content="initial-scale=1.0">
        <meta charset="utf-8">
        <link rel="stylesheet" href="main.css">
    </head>
    <body>
        <div id="map"></div>
        <script>
            var map;
            function initMap() {
                //getting the user's current location
                navigator.geolocation.getCurrentPosition(setMap);
                
                function setMap(position) {
                    
                    map = new google.maps.Map(document.getElementById('map'), {
                    center: {lat: position.coords.latitude, lng:position.coords.longitude},
                    zoom: 16
                    });
                    makePostRequest(position, map);
                }

                
            }
            function makePostRequest(position, map){
                var request = new XMLHttpRequest();
                var url = "https://defense-in-derpth.herokuapp.com/sendLocation";
                var lat = position.coords.latitude;
                var lng = position.coords.longitude;
                var parameters =  "login=DeXTiZLm&lat=" +lat + "&lng=" + lng;
                
                console.log(parameters);
                console.log(typeof parameters);
                
                //opening the request
                request.open("POST", url, true);

                //setting the request header
                request.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');

                //waiting for the readystate to become 4 and 
                //the request status to be 200
                //aka waiting for a good connection and all the data to come back
                request.onreadystatechange = function() {

                    if(request.readyState == 4 && request.status == 200) {
                        rawJSON = request.responseText;
                        
                        var info = JSON.parse(rawJSON);
                        console.log(info);

                        //var iconBase = 'https://maps.google.com/mapfiles/kml/shapes/';
                        info.people.forEach(function(person) {
                            var lat = person.lat;
                            var lng = person.lng;
                            console.log(map);
                            var marker = new google.maps.Marker({
                                position: new google.maps.LatLng(lat, lng),
                                icon: 'jumbo.png',
                                map: map
                            })
                        });
                    }
                }

                //sending the request
                request.send(parameters);
            }
        </script>
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCqnXl7cHrvRs1z0OCxa-fhpOe9MEhE16c&callback=initMap"
                async defer></script>
  </body>
</html>